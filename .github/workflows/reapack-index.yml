name: ReaPack Indexer

on:
  push:
    branches: [ main, master ]
    paths:
      - 'Release/REAPER/**'
      - '.github/workflows/reapack-index.yml'
  workflow_dispatch:

jobs:
  update-index:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # 完整历史记录
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          echo "=== Git 配置完成 ==="
          git config --list | grep user
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
      
      - name: Install reapack-index
        run: |
          gem install reapack-index
          echo "=== reapack-index 安装完成 ==="
          reapack-index --version
      
      - name: Debug - Show environment
        run: |
          echo "=== 环境信息 ==="
          echo "当前目录: $(pwd)"
          echo "用户: $(whoami)"
          echo "Release 目录内容:"
          ls -la Release/
          echo ""
          echo "配置文件:"
          cat Release/.reapack-index.yml
          echo ""
          echo "Git 状态:"
          git status --short
      
      - name: Run reapack-index
        run: |
          cd Release
          echo "=== 开始运行 reapack-index ==="
          echo "当前目录: $(pwd)"
          
          # 使用 --commit 参数自动提交，无需交互确认
          reapack-index --rebuild --commit 2>&1 | tee reapack-output.log || {
            echo ""
            echo "=== reapack-index 执行失败 ==="
            echo "退出码: $?"
            echo ""
            echo "输出日志:"
            cat reapack-output.log
            echo ""
            echo "当前 Git 状态:"
            git status
            exit 1
          }
          
          echo ""
          echo "=== reapack-index 执行成功 ==="
          rm -f reapack-output.log
      
      - name: Check for new commits
        id: check-commits
        run: |
          cd Release
          # reapack-index --commit 会创建提交，检查是否有新提交需要推送
          if [ -n "$(git log origin/main..HEAD --oneline)" ]; then
            echo "has_commits=true" >> $GITHUB_OUTPUT
            echo "✅ 有新的 index 提交需要推送"
            git log origin/main..HEAD --oneline
          else
            echo "has_commits=false" >> $GITHUB_OUTPUT
            echo "ℹ️ 无新提交"
          fi
      
      - name: Push index updates
        if: steps.check-commits.outputs.has_commits == 'true'
        run: |
          cd Release
          git push
      
      - name: Summary
        if: always()
        run: |
          echo "=== 最终状态 ==="
          echo "index.xml 大小: $(wc -l < Release/index.xml) 行"
          echo "ReaPet 条目:"
          grep -c "zyc_ReaPet" Release/index.xml || echo "0"
          echo ""
          echo "✅ 工作流完成"
